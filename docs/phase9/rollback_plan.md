# Phase 9 롤백 플랜

작성일: 2026-01-23
버전: v1.0

---

## 1. 개요

### 1.1 목적
Phase 9 릴리스 후 심각한 문제 발생 시 안전하게 이전 상태로 복귀하기 위한 절차를 정의한다.

### 1.2 범위
- Phase 7 포트폴리오 평가 기능
- 관련 API 엔드포인트
- 프론트엔드 UI

---

## 2. 롤백 트리거 조건 (Story 5.1)

### 2.1 즉시 롤백 (Severity: Critical)

| ID | 트리거 조건 | 판단 기준 | 담당 |
|----|------------|-----------|------|
| T-001 | 결과 불일치 | 동일 입력에 다른 결과 반환 | 개발팀 |
| T-002 | 법적 표현 이슈 | 금지 표현 결과에 포함 | 법무/개발팀 |
| T-003 | 데이터 무결성 | 저장된 데이터 손상/누락 | 인프라팀 |
| T-004 | 전체 서비스 장애 | 5분 이상 API 응답 불가 | 운영팀 |

### 2.2 조건부 롤백 (Severity: High)

| ID | 트리거 조건 | 임계치 | 관찰 기간 |
|----|------------|--------|-----------|
| T-101 | 5xx 오류율 | > 5% | 5분 지속 |
| T-102 | API 응답 시간 | p95 > 10초 | 10분 지속 |
| T-103 | 평가 실패율 | > 20% | 15분 지속 |
| T-104 | DB 연결 오류 | 연속 3회 | 즉시 |

### 2.3 성능 임계치 (Severity: Medium)

| ID | 트리거 조건 | 임계치 | 조치 |
|----|------------|--------|------|
| T-201 | 응답 지연 | p95 > 5초 | 모니터링 강화 |
| T-202 | 메모리 사용량 | > 85% | 스케일 아웃 검토 |
| T-203 | DB 쿼리 지연 | avg > 1초 | 쿼리 최적화 검토 |

---

## 3. 롤백 절차 (Story 5.2)

### 3.1 단계별 롤백 절차

```
┌──────────────────────────────────────────────────────────────┐
│                    롤백 절차 흐름도                           │
├──────────────────────────────────────────────────────────────┤
│                                                              │
│  [트리거 감지] ──→ [심각도 판단] ──→ [롤백 결정]              │
│                          │                                   │
│                          ▼                                   │
│                    Critical/High?                            │
│                     │         │                              │
│                    Yes        No                             │
│                     │         │                              │
│                     ▼         ▼                              │
│              [즉시 롤백]  [모니터링 강화]                     │
│                     │                                        │
│                     ▼                                        │
│              [기능 플래그 OFF]                                │
│                     │                                        │
│                     ▼                                        │
│              [이전 버전 배포]                                 │
│                     │                                        │
│                     ▼                                        │
│              [검증 및 공지]                                   │
│                                                              │
└──────────────────────────────────────────────────────────────┘
```

### 3.2 Phase 1: 기능 플래그 OFF

**목적:** Phase 7 기능 비활성화 (서비스 유지)

**절차:**
1. 환경 변수 설정
   ```bash
   # Phase 7 평가 기능 비활성화 (현재는 Feature Flag 없음)
   # API 레벨에서 503 반환하도록 설정
   PHASE7_MAINTENANCE_MODE=1
   ```

2. 프론트엔드 공지
   - 평가 페이지에 "점검 중" 메시지 표시
   - 기존 이력 조회는 유지

3. 검증
   - [ ] 평가 API 503 반환 확인
   - [ ] 이력 조회 정상 동작 확인
   - [ ] 프론트엔드 메시지 표시 확인

### 3.3 Phase 2: 이전 버전 배포

**목적:** Phase 8 안정 버전으로 복귀

**절차:**
1. 백엔드 롤백
   ```bash
   # Git 태그 기준 롤백
   git checkout tags/phase8-stable

   # 또는 커밋 해시 기준
   git checkout <phase8-last-commit-hash>
   ```

2. 데이터베이스 처리
   - Phase 7 테이블 데이터 보존 (삭제 금지)
   - 마이그레이션 롤백 불필요 (Phase 7 테이블 독립)

3. 프론트엔드 롤백
   ```bash
   # Phase 8 버전 배포
   git checkout tags/phase8-stable-frontend
   npm run build && npm run deploy
   ```

4. 검증
   - [ ] Phase 8 기능 정상 동작 확인
   - [ ] Phase 7 API 404 반환 확인
   - [ ] 기존 사용자 데이터 영향 없음 확인

### 3.4 Phase 3: 로그 보존 및 원인 분석

**목적:** 장애 원인 파악을 위한 증거 보존

**절차:**
1. 로그 백업
   ```bash
   # 애플리케이션 로그
   cp /var/log/app/*.log /backup/incident-$(date +%Y%m%d)/

   # DB 쿼리 로그
   cp /var/log/postgresql/*.log /backup/incident-$(date +%Y%m%d)/
   ```

2. DB 스냅샷
   ```bash
   # 장애 시점 데이터 백업
   pg_dump -Fc kingo_db > /backup/incident-$(date +%Y%m%d)/db_snapshot.dump
   ```

3. 원인 분석
   - [ ] 오류 로그 분석
   - [ ] 트리거된 조건 확인
   - [ ] 재현 테스트 수행
   - [ ] 근본 원인 리포트 작성

---

## 4. 롤백 시나리오별 대응

### 4.1 시나리오 A: 결과 불일치 (T-001)

**증상:** 동일 입력에 대해 다른 결과 반환

**대응:**
1. 즉시 평가 API 중단 (`PHASE7_MAINTENANCE_MODE=1`)
2. 영향받은 사용자 식별
3. 로그 분석으로 불일치 원인 파악
4. 수정 후 재배포 또는 롤백 결정

**복구 후 조치:**
- 영향받은 평가 결과 무효화 고지
- 재평가 안내

### 4.2 시나리오 B: 법적 표현 이슈 (T-002)

**증상:** 금지 표현이 결과에 포함됨

**대응:**
1. 즉시 서비스 중단
2. 문제 표현 포함된 결과 식별
3. DB에서 문제 결과 마킹 (삭제 금지)
4. 수정 후 재배포

**복구 후 조치:**
- 영향받은 결과 재생성
- 필요시 사용자 공지

### 4.3 시나리오 C: 성능 저하 (T-101, T-102)

**증상:** API 응답 지연 또는 오류율 증가

**대응:**
1. 트래픽 분석
2. 스케일 아웃 시도
3. 개선 없으면 롤백 결정

**복구 후 조치:**
- 성능 프로파일링
- 쿼리/코드 최적화

---

## 5. 연락 체계

### 5.1 에스컬레이션 경로

```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│   L1 운영    │ →  │   L2 개발    │ →  │  L3 인프라   │
│  (15분 내)   │    │  (30분 내)   │    │  (1시간 내)  │
└─────────────┘    └─────────────┘    └─────────────┘
```

### 5.2 비상 연락망

| 역할 | 담당자 | 연락처 | 백업 담당자 |
|------|--------|--------|-------------|
| L1 운영 | (작성 필요) | | |
| L2 개발 | (작성 필요) | | |
| L3 인프라 | (작성 필요) | | |
| PM | (작성 필요) | | |

### 5.3 커뮤니케이션 채널

| 채널 | 용도 | 담당 |
|------|------|------|
| Slack #ops-alert | 실시간 알림 | 자동 |
| Slack #incident | 장애 대응 협업 | 전원 |
| Email | 공식 공지 | PM |

---

## 6. 롤백 체크리스트

### 6.1 롤백 전

- [ ] 트리거 조건 확인
- [ ] 심각도 판단
- [ ] 롤백 결정 승인 (PM/개발 리드)
- [ ] 영향 범위 파악
- [ ] 롤백 절차 확인

### 6.2 롤백 중

- [ ] 로그 백업 완료
- [ ] DB 스냅샷 완료
- [ ] 기능 플래그 OFF
- [ ] 이전 버전 배포
- [ ] 검증 테스트 통과

### 6.3 롤백 후

- [ ] 서비스 정상화 확인
- [ ] 사용자 영향 확인
- [ ] 원인 분석 시작
- [ ] 사후 리포트 작성
- [ ] 재발 방지 대책 수립

---

## 7. 복구 후 재배포 절차

### 7.1 재배포 조건

- [ ] 근본 원인 파악 완료
- [ ] 수정 사항 검증 완료
- [ ] 재발 방지 대책 적용
- [ ] QA 승인
- [ ] PM 승인

### 7.2 재배포 절차

1. 수정 사항 코드 리뷰
2. 테스트 환경 검증
3. 스테이징 환경 검증
4. 점진적 롤아웃 (Canary)
5. 전체 배포
6. 모니터링 강화 (24시간)

---

## 8. 버전 이력

| 버전 | 일자 | 변경 내용 |
|------|------|-----------|
| v1.0 | 2026-01-23 | 최초 작성 |

---

## 9. 참조 문서

- [release_checklist.md](release_checklist.md) - 릴리스 체크리스트
- [epic3_log_audit_report.md](epic3_log_audit_report.md) - 로그 아키텍처
- [result_wording_final.md](result_wording_final.md) - 금지 표현 목록
