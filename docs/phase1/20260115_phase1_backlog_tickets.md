# Foresto Phase 1 작업 티켓 백로그 (PR 단위)
작성일: 2026-01-15

Phase 0(정렬 단계: 추천 제거/시나리오 플로우/손실·회복 KPI/재현성 최소요건) 완료를 전제로,  
Phase 1은 **“데이터 기반 운영 가능한 시뮬레이션 인프라”**를 구축하는 단계이다.

핵심 목표:
1) 시계열 데이터(가격/수익률)를 **표준 테이블**로 적재·관리  
2) 시나리오/포트폴리오 구성비를 **정규화**하여 관리형 콘텐츠화  
3) 시뮬레이션 결과를 **sim_run/sim_path/sim_summary** 구조로 저장 및 재사용  
4) 파티셔닝/적재이력/버전관리로 운영 안정성 확보

---

## Epic P1-A. 데이터 모델(물리) 도입 및 마이그레이션

### P1-A1. PostgreSQL 스키마/기본 테이블 생성 (DDL 적용)
- **목적**: Foresto 핵심 테이블(기준정보/원천/마트/시나리오/시뮬레이션) 물리화
- **범위**
  - `모델버전등록부`, `원천적재이력`
  - `금융상품기준정보`
  - `일봉가격(파티션)` / `일간수익률(파티션)`
  - `시나리오정의`, `포트폴리오모델`, `포트폴리오구성비`
  - `시뮬레이션실행`, `시뮬레이션경로(파티션)`, `시뮬레이션요약지표`
- **수용 기준(AC)**
  - 로컬/개발 DB에 DDL 적용 성공
  - 파티션 생성 함수 및 샘플 파티션 생성 포함
- **산출물**
  - `db/ddl/foresto_phase1.sql`
  - 적용 방법 문서(`docs/db_setup.md`)

### P1-A2. 기존 “시뮬레이션 결과 저장소”에서 sim_* 구조로 이관(스키마 레벨)
- **목적**: Phase 0의 request_hash/engine_version 결과를 표준 sim_*로 저장
- **작업 내용**
  - 기존 테이블/JSON 저장 구조가 있다면 `시뮬레이션실행` 및 `시뮬레이션요약지표`로 매핑
  - 경로(일별 NAV/낙폭) 데이터가 존재하면 `시뮬레이션경로`로 매핑
- **수용 기준(AC)**
  - 신규 시뮬레이션 실행 1건이 sim_run/sim_path/sim_summary에 저장됨
  - request_hash 기반 재사용이 DB 조회로 동작

---

## Epic P1-B. 데이터 적재(ETL) 파이프라인 최소 구축

### P1-B1. 금융상품기준정보 적재 스크립트(Seed)
- **목적**: 운영 가능한 최소 유니버스(ETF/지수/환율) 정의
- **작업 내용**
  - `scripts/seed_instruments.py` 작성
  - 최소 유니버스 예시(팀에서 확정):
    - KRX 대표 ETF, 미국 대표 ETF
    - FX: USDKRW
  - 중복 방지(상품유형+티커+거래소 유니크)
- **수용 기준(AC)**
  - seed 실행 시 금융상품기준정보 테이블에 upsert 됨
  - 적재 로그 및 원천적재이력(load) 레코드 생성

### P1-B2. 일봉가격 적재(관리자/배치) + 원천적재이력 기록
- **목적**: 시뮬레이션 엔진이 표준 테이블에서 가격을 조회하도록 전환
- **작업 내용**
  - 초기 데이터 소스는 단일 소스로 시작(예: CSV/내부 API/공식 데이터 중 택1)
  - ETL 입력 파일/응답을 Raw로 보관(옵션) + load_id 발급
  - `일봉가격`에 (금융상품ID, 거래일자) upsert
- **수용 기준(AC)**
  - 1개 상품이라도 1년치 데이터 적재 후 조회 가능
  - 결측/휴장일 처리 기준 문서화

### P1-B3. 일간수익률 생성 배치
- **목적**: 분석/시뮬레이션 계산의 표준 입력(수익률) 생성
- **작업 내용**
  - 가격 테이블에서 일간수익률 계산하여 `일간수익률`에 적재
  - data_quality(OK/MISSING/IMPUTED) 관리(초기엔 OK/MISSING만)
  - 모델버전/엔진버전 연계
- **수용 기준(AC)**
  - 지정 기간에 대해 수익률이 생성되고, 시뮬레이션에서 사용됨

---

## Epic P1-C. 시나리오/포트폴리오 관리형 콘텐츠화

### P1-C1. 시나리오/포트폴리오 구성비 DB화(관리자 전용)
- **목적**: “추천”이 아닌 “관리형 시나리오”로 포트폴리오를 고정
- **작업 내용**
  - 관리자 API(또는 초기 seed)로 시나리오 및 구성비 등록
  - 구성비는 `(포트폴리오ID, 적용일자, 금융상품ID, 비중)` 정규화 저장
- **수용 기준(AC)**
  - 시나리오 3종이 DB에 저장되고, `GET /scenarios`가 DB 조회로 동작
  - 구성비 합(1.0) 검증 로직 적용(서비스/DB 중 최소 1곳)

### P1-C2. 시나리오 선택 입력에 “손실한도/기간” 1급 반영
- **목적**: Foresto 핵심 입력(기간/손실한도) 기반 비교
- **작업 내용**
  - `POST /simulations/run` 요청 스키마 확정:
    - scenario_id
    - start_date / end_date (또는 duration)
    - max_loss_limit_pct (optional but recommended)
- **수용 기준(AC)**
  - 설문 없이도 시나리오+기간 입력만으로 실행 가능
  - request_hash가 이 입력으로 결정됨

---

## Epic P1-D. 시뮬레이션 엔진 전환(표준 테이블 기반)

### P1-D1. 시나리오 기반 포트폴리오 경로 계산(표준화)
- **목적**: 기존 임의 구성/추천 대신 “구성비” 기반 계산으로 완전 전환
- **작업 내용**
  - 포트폴리오 구성비(적용일자 기준) 로딩
  - `일간수익률` 결합
  - 일별 NAV(지수값) 경로 산출 + 낙폭 산출
- **수용 기준(AC)**
  - 동일 입력 → 동일 결과 (DB 캐시 포함)
  - `시뮬레이션경로`에 일별 값 저장

### P1-D2. 손실/회복 핵심 지표 산출 및 저장
- **목적**: Foresto KPI를 `시뮬레이션요약지표`에 표준 저장
- **작업 내용**
  - MDD, 최대회복일수, 최악1M/3M(가능 시) 계산
  - (보조) CAGR, 연환산변동성 계산
- **수용 기준(AC)**
  - 시뮬레이션 응답이 손실/회복 지표를 포함
  - `시뮬레이션요약지표`에 저장됨

---

## Epic P1-E. 운영(파티션/보관/품질)

### P1-E1. 파티션 자동 생성(월 단위) 운영 스크립트/잡
- **목적**: 적재 실패 방지 및 성능 유지
- **작업 내용**
  - `scripts/create_partitions.py` 또는 SQL 함수 호출 배치
  - 최소: 미래 6개월 파티션 선생성
- **수용 기준(AC)**
  - 월초 배치가 실패해도 수동 재실행 가능
  - 운영 문서에 절차 포함

### P1-E2. TTL/보관 정책(시뮬레이션 결과)
- **목적**: 저장 비용/개인정보 위험 최소화
- **작업 내용**
  - sim_* 테이블 TTL 정책 정의(예: sim_path 90일, sim_summary 1년)
  - 드롭/아카이브 절차 문서화
- **수용 기준(AC)**
  - 운영자가 정책대로 정리 가능(스크립트/SQL 제공)

### P1-E3. 품질 리포트/스모크 테스트 확장
- **목적**: DB/ETL까지 품질 게이트 확장
- **작업 내용**
  - ETL 수행 후 레코드 카운트/결측률 리포트 산출
  - API 스모크: `/scenarios`, `/simulations/run`, `/simulations/{id}`
- **수용 기준(AC)**
  - 최소 품질 리포트 산출(마크다운 또는 로그)

---

## Definition of Done (Phase 1)
- 시나리오 3종이 DB에 존재하고 API로 조회된다.
- 가격/수익률이 표준 테이블에 적재되어 엔진이 이를 사용한다.
- 시뮬레이션 결과가 `시뮬레이션실행/경로/요약`에 저장되며 `요청해시`로 재사용된다.
- 파티셔닝이 적용되어 대량 조회 성능이 유지된다.
