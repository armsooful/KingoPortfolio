# ForestoCompass 현행 코드 분석 및 Foresto 목표 정합성 가이드
최초작성일자: 2026-01-14
최종수정일자: 2026-01-18

작성일: 2026-01-14

본 문서는 사용자가 제공한 코드 베이스(`ForestoCompass.zip` → `KingoPortfolio-main/`)를 분석하여,
Foresto 프로젝트의 목표(“의사결정 보조형 투자 인프라”)와 비교했을 때 **이미 구현된 것**, **부족/미흡한 것**, **방향이 다른 것(드리프트)**을 정리하고,
개발팀이 다음 단계에서 무엇을 유지/개선/폐기해야 하는지에 대한 **실행 가이드**를 제공한다.

---

## 1. 분석 범위 및 코드 베이스 개요

### 1.1 분석 범위
- Backend: `backend/app/*` (FastAPI + SQLAlchemy)
- Frontend: `frontend/*` (React + Vite)
- 문서: 루트 및 `backend/docs` 포함 md 문서들

### 1.2 규모(정적 파일 카운트)
- Python 파일: 75개
- JS/JSX 파일: 39개
- Markdown 문서: 63개

### 1.3 현재 프로젝트 포지셔닝(코드/문서 기준)
- 루트 `README.md` 상단에는 “Foresto Compass: 투자 전략 학습용 포트폴리오 시뮬레이션”으로 표기되어 있으나,
  동일 문서 내 소개는 **“AI 기반 투자 포트폴리오 추천 플랫폼”**으로 서술됨.
- 코드에서도 “교육 목적” 고지를 반복하나, 실제 구현은 다음 기능을 포함한다:
  - 설문 기반 성향 진단
  - 성향별 자산배분 및 종목/ETF/채권/예금 **선정(추천 형태)**
  - 기대수익률/예상수익률 출력
  - 백테스트/비교 기능 일부

> 결론: **설명(Explanation) 중심**으로 가려는 의도는 존재하나, 구현은 **추천(Recommendation) 중심** 구성 요소가 상당히 포함되어 있어 목표와 충돌 가능성이 높다.

---

## 2. Foresto 목표(기준선) 요약

Foresto의 기준선(이 대화에서 합의된 개발 매뉴얼/데이터 모델 방향)은 아래와 같다.

1) **예측이 아니라 시뮬레이션**: 과거 데이터 기반 결과 제시  
2) **추천이 아니라 설명**: “이 선택을 하면 어떤 손실을 감내했고, 회복에 얼마나 걸렸는가” 중심  
3) **개인/계좌 데이터 최소화**: 계좌연동·실거래·잔고 관리 불필요(초기)  
4) **데이터 재현성**: 모델버전/입력해시 기반 동일 입력→동일 결과  
5) **핵심 데이터 모델**: 금융상품/시계열(가격, 수익률), 시나리오, 포트폴리오 비중 이력, 시뮬레이션 실행/경로/요약 저장

---

## 3. 현재 구현 현황 (무엇이 이미 구현되어 있는가)

### 3.1 장점 및 재사용 가능한 기반
**(A) API/서비스 기반**
- FastAPI 프로젝트 구조, 라우터 분리, 에러 핸들링/레이트리미터 구성  
  - 예: `backend/app/main.py`, `backend/app/error_handlers.py`, `backend/app/rate_limiter.py`
- 인증/권한(RBAC, Admin) 및 사용자 관리 기반 존재  
  - 예: `backend/app/auth.py`, `backend/app/models/user.py`, `backend/app/routes/admin.py`

**(B) “교육 목적/비권유” 고지 체계**
- 법적 고지/용어 가이드 문서가 다수 존재  
  - 예: `DISCLAIMER_AND_TERMINOLOGY_SUMMARY.md`, `TERMINOLOGY_GUIDE.md`
- 코드 주석에서도 “투자 권유 아님”을 반복하여 표기(의도 자체는 Foresto 방향과 일치)

**(C) 백테스트/비교 기능의 뼈대**
- 포트폴리오 백테스트 엔드포인트 및 비교 엔드포인트 존재  
  - 예: `backend/app/routes/backtesting.py`
- 포트폴리오 히스토리/비교(관리자용) 기능 존재  
  - 예: `backend/app/routes/portfolio_comparison.py`, `backend/app/models/portfolio.py`
- PDF 리포트 기능 라우터 존재(Foresto의 “설명 중심 리포트”로 확장 가능)  
  - 예: `backend/app/routes/pdf_report.py`

> 재사용 결론: **API 골격/권한/운영(레이트리밋)/리포트 출력**은 Foresto에 그대로 활용 가능하다.

---

## 4. 목표 대비 “방향이 다른 부분”(드리프트) 정리

Foresto 기준선과 비교했을 때, 아래는 기능·모델·표현 레벨에서 드리프트가 확인되는 지점이다.

### 4.1 추천/선정 로직(핵심 드리프트)
- **개별 주식/ETF/채권/예금 상품을 DB에서 골라 “추천”하는 구조**
  - `backend/app/db_recommendation_engine.py`
  - `backend/app/services/portfolio_engine.py` (섹터 선호, 배당 선호, 점수화, 종목 선정 등)
- 응답에 `expected_return`, `reason`, “추천 예금 상품” 등 **추천형 어휘/필드**가 포함됨
- 이는 “설명(Explanation) 중심”이 아니라 “선정(Selection) 중심”으로 해석될 여지가 있음

**가이드**
- Foresto에서는 종목/상품 “선정”이 아니라, **사전에 정의된 시나리오(ETF 바스켓/자산군 비중) 결과를 설명**하는 구조로 전환 권장.
- “추천”이라는 용어를 API/응답/프론트 카피에서 제거하고, “예시/시나리오/모의실험”으로 표준화.

### 4.2 기대수익률 제시(표현 리스크 및 방향 불일치)
- 진단 프로필에 `expected_annual_return`를 상수 문자열로 제공  
  - `backend/app/diagnosis.py`
- API가 “예상 수익률”을 직접 시뮬레이션한다고 설명/제공하는 부분이 존재  
  - `backend/app/routes/portfolio.py`의 `/simulate` 등

**가이드**
- Foresto 핵심 KPI는 CAGR 자체가 아니라 **MDD·회복기간·손실분포**이며,
  “기대수익률”은 오히려 규제/신뢰 리스크를 키울 수 있다.
- 출력 우선순위를 “손실/회복” 중심으로 재구성하고, 기대수익률은 필요 시에도 “과거 기간의 관측치”로 엄격히 제한.

### 4.3 입력모델: 설문 기반 성향(현재) vs 손실한도/기간 기반(목표)
- 현재는 15문항 설문으로 `conservative/moderate/aggressive` 분류
  - `backend/app/main.py`의 `SURVEY_QUESTIONS`
  - `backend/app/diagnosis.py`의 `calculate_diagnosis`
- 목표는 “사용자 판단을 돕는 최소 입력”: 기간, 손실한도, 목표 이벤트 등

**가이드**
- 설문은 유지 가능하나, Foresto 핵심 플로우에서는 **손실한도(예: 최대 허용 MDD)와 투자기간**이 1급 입력이어야 한다.
- 설문 결과는 “용어 선택/UX 가이드” 정도로 하위 기능으로 격하하는 것을 권장.

### 4.4 데이터 모델: 운영 가능한 시계열/시뮬레이션 저장 구조 부재
- 현재 DB 모델은 사용자/진단/포트폴리오(구성 JSON) 중심이며,
  Foresto 목표의 핵심 테이블(금융상품기준정보, 일봉가격, 일간수익률, 시나리오정의, 시뮬레이션실행/경로/요약)이 없다.
  - 예: `backend/app/models.py`, `backend/app/models/portfolio.py`

**가이드**
- Foresto 논리 모델을 물리화(PostgreSQL)하고,
  포트폴리오 구성은 JSON이 아닌 **(포트폴리오ID, 적용일자, 금융상품ID, 비중)** 구조로 이관해야 한다.
- 시뮬레이션은 “일회성 계산 결과”가 아니라, **실행 단위(sim_run) + 경로(sim_path) + 요약(sim_summary)**로 저장해야 재현성과 서빙 성능을 확보한다.

### 4.5 재현성/버전관리: 부분적으로 존재하나 일관되지 않음
- 문서/주석으로 법적·용어·정책은 존재하나,
  계산 결과에 대한 **모델버전/엔진버전/입력해시 기반 캐시**가 전면 적용되어 있지 않다.
- 일부는 레이트리밋으로 “AI 분석”처럼 취급하나, 실제로는 deterministic 엔진이어야 한다.

**가이드**
- 모든 시뮬레이션 실행은 `요청해시(request_hash)`를 생성하고,
  동일 해시가 있으면 결과 재사용(캐시)하도록 표준화.
- DB에 `모델버전등록부`(model registry)를 두고, 결과 테이블에 version을 강제.

---

## 5. 목표 대비 “부족하거나 미흡한 부분”(갭) 체크리스트

아래 항목은 Foresto 방향에서 MVP에 필요하지만, 현재 코드에서 부족하거나 미흡한 영역이다.

### 5.1 데이터 계층(원천→정규화→마트→서빙) 부재
- 현재는 금융상품 시계열을 1급 시민으로 다루기보다, DB에 “상품 정보”가 중심.
- 시계열은 backtest 내부에서 조회/계산될 가능성이 있으나, 표준 테이블/품질 플래그/적재이력 추적이 없다.

### 5.2 손실/회복 중심 지표 체계 미흡
- 백테스트 결과는 `annualized_return`, `volatility`, `sharpe_ratio`, `max_drawdown` 등 전통적 지표 위주
  - `backend/app/routes/backtesting.py`
- Foresto 핵심인 “회복기간”, “최악 구간 지속”, “위기구간별 결과”가 1급 결과로 제공되지 않는다.

### 5.3 시나리오/포트폴리오 정의의 분리 부족
- “투자성향” 중심으로 포트폴리오를 즉석 생성(그리고 종목을 골라 담음)
- Foresto는 “시나리오정의/포트폴리오모델”을 **관리형 콘텐츠**로 두고,
  사용자는 이를 선택해 비교해야 한다.

### 5.4 파티셔닝/대량 조회 설계 미적용
- Postgres 지원 문구는 있으나, 시계열 대량 적재/조회 관점의 파티셔닝 전략이 코드/마이그레이션에 반영되어 있지 않다.

---

## 6. 전환 가이드 (유지/폐기/리팩터링 우선순위)

### 6.1 즉시 유지(Keep)
- 인증/권한/레이트리밋/예외처리 기반
- PDF 리포트 생성 프레임(단, 내용은 Foresto 지표로 교체)
- 백테스트 엔드포인트 “틀”(단, 입력/출력/용어 교체)

### 6.2 단계적 폐기 또는 격하(De-scope)
- “추천 상품 조회/추천 종목 선정” 계열
  - `db_recommendation_engine.py`
  - `PortfolioEngine`의 종목 스코어링/선정 로직 다수
- “기대 수익률(예상 수익률)”을 전면에 내세우는 출력

### 6.3 리팩터링(Refactor)
- 설문 기반 성향 결과는 유지하되, Foresto 핵심 입력(기간/손실한도) 중심으로 UX/API를 재구성
- 백테스트/비교 결과를 손실·회복 중심으로 변경
- 데이터 모델 전면 개편(아래 7장 참고)

---

## 7. Foresto 목표 데이터 모델로의 이행(권장 설계)

### 7.1 신규 핵심 테이블(목표)
- 금융상품기준정보(=dim_instrument)
- 일봉가격(=fact_price_eod)
- 일간수익률(=mart_return_daily)
- 시나리오정의(=scenario_definition)
- 포트폴리오모델(=portfolio_model)
- 포트폴리오구성비(=portfolio_weight)
- 시뮬레이션실행(=sim_run)
- 시뮬레이션경로(=sim_portfolio_path)
- 시뮬레이션요약지표(=sim_summary_metrics)

### 7.2 기존 테이블과의 매핑/처리
- `portfolios.composition(JSON)` → **포트폴리오구성비 테이블로 분해** (적용일자 포함)
- `portfolio_histories` → Foresto의 `시뮬레이션경로`와 목적이 유사하나,
  “사용자 포트폴리오 추적”인지 “시뮬레이션 결과 저장”인지 목적을 분리해야 한다.

---

## 8. API 설계 가이드(목표 상태)

### 8.1 필수 API (MVP)
- `GET /scenarios` : 시나리오 목록
- `GET /scenarios/{id}` : 시나리오 상세(자산군/ETF 구성, 제약, 리밸런싱)
- `POST /simulations/run` : 시뮬레이션 실행(기간/손실한도/시나리오ID 등 입력)
- `GET /simulations/{sim_id}` : 요약 + 차트용 경로 + 손실/회복 지표
- `GET /instruments` : 금융상품 검색/메타
- `POST /data/load` (관리자) : 원천 적재 작업 트리거(초기에는 배치 스크립트로 대체 가능)

### 8.2 금지/주의 API (목표 위반 위험)
- “추천 종목/추천 ETF” 형태의 엔드포인트
- 사용자 개인화 자산배분을 “권장 비중”으로 제시하는 엔드포인트(시나리오가 아닌 경우 특히 위험)

---

## 9. 개발 로드맵(현 코드 → 목표 정렬)

### Sprint 1: 포지셔닝/용어/출력 정렬
- “추천” 어휘 제거(코드/응답/프론트 카피)
- `expected_return` 제거 또는 “과거 관측 범위”로 축소
- 결과 UI를 “손실/회복” 중심으로 재배치

### Sprint 2: 데이터 모델 도입(최소 세트)
- `금융상품기준정보`, `일봉가격`, `일간수익률` 물리 테이블 도입
- 적재이력/모델버전 테이블 도입(재현성 기반)

### Sprint 3: 시나리오/시뮬레이션 엔진 전환
- 시나리오정의/포트폴리오모델/구성비 관리
- `sim_run + sim_path + sim_summary` 저장
- 입력해시 기반 캐시 적용

### Sprint 4: 리포트/비교 고도화
- 위기구간별 결과 비교(2008/2020/2022 등 기간 태그)
- 회복기간 분포, 최악구간 지속일 등 핵심 지표 제공
- PDF 리포트 템플릿을 Foresto 지표 중심으로 교체

---

## 10. 개발팀 체크리스트(리뷰 기준)

### 10.1 기능/표현
- [ ] “추천/최적/보장” 등의 어휘가 API 응답 및 UI에 존재하지 않는다.
- [ ] 기대수익률을 약속하는 수치/문구가 없다(또는 과거 관측치로만 제한).
- [ ] 손실(MDD)·회복기간(Recovery)·최악기간(Worst Window)이 핵심으로 노출된다.

### 10.2 데이터/재현성
- [ ] 모든 결과 레코드는 `모델버전`과 연결된다.
- [ ] 모든 시뮬레이션은 `요청해시`로 캐시/재현이 가능하다.
- [ ] 시계열 테이블은 날짜 파티셔닝으로 운영된다(월 단위 권장).

### 10.3 아키텍처
- [ ] 포트폴리오 구성은 JSON이 아니라 정규화 테이블로 관리된다.
- [ ] 분석(엔진)과 서빙(API)이 분리되어 책임이 명확하다.

---

## 11. 결론

현재 코드 베이스는 “교육용/비권유” 문구와 백테스트/리포트 기반 등 유의미한 토대를 갖고 있다.  
그러나 구현의 중심이 **성향 진단 → (상품/종목) 선정(추천) → 기대수익률 제시**로 구성되어 있어,
Foresto 목표(설명/손실·회복 중심, 시나리오 기반)와는 **핵심 축이 다르다**.

따라서 다음 원칙으로 정렬을 권장한다.

1) **추천 제거**: 종목 선정/추천 엔진 축소 또는 폐기  
2) **시나리오 도입**: 관리형 시나리오/ETF 바스켓 중심으로 전환  
3) **데이터 모델 교체**: 시계열/시뮬레이션 저장 구조 도입  
4) **결과 지표 재정의**: 손실·회복 중심으로 KPI/UX 재구성  

---

### 부록 A. 주요 드리프트 발생 파일(우선 점검)
- `backend/app/db_recommendation_engine.py`
- `backend/app/services/portfolio_engine.py`
- `backend/app/diagnosis.py` (expected return 포함)
- `backend/app/routes/portfolio.py` (추천/예상 수익률 성격 API 포함)
