# ForestoCompass 정합성 정렬: 상세 티켓 백로그 (PR 단위)
최초작성일자: 2026-01-14
최종수정일자: 2026-01-18

작성일: 2026-01-14

본 문서는 `ForestoCompass(KingoPortfolio-main)` 현행 코드베이스를 Foresto 목표(의사결정 보조 / 시나리오 기반 / 손실·회복 중심 / 재현성)로 정렬하기 위한 **상세 개발 티켓(백로그)**이다.  
각 티켓은 **하나의 PR**로 제출 가능하도록 범위를 쪼갰다.

---

## 0. 공통 규칙 (모든 티켓에 적용)
- **금지 용어(코드/응답/화면)**: 추천, 최적, 보장, 반드시, 유리, pick, best, top 추천형 표현
- **허용 용어**: 시나리오, 예시, 모의실험, 과거 관측, 비교, 설명, 리스크 특성
- 모든 API 응답은 **손실/회복 지표가 최상단**에 위치하도록 정렬
- 시뮬레이션 요청은 canonical JSON을 기반으로 `request_hash`를 생성해야 함
- 임시 방편이 필요하면 **Feature Flag**로 우회하되, 최종적으로 추천 엔진 호출 경로를 제거/격하

---

## Epic A. 추천(Recommendation) 드리프트 제거

### A-1. Feature Flag로 추천 엔진 호출 경로 차단 (Backend)
- **목적**: 추천/선정 로직이 호출되지 않도록 즉시 차단하여 규제/신뢰 리스크를 낮춤
- **대상 파일(우선)**  
  - `backend/app/db_recommendation_engine.py`  
  - `backend/app/services/portfolio_engine.py`  
  - (호출 측) `backend/app/routes/portfolio.py` 또는 관련 라우터
- **작업 내용**
  1. 환경변수 `FEATURE_RECOMMENDATION_ENGINE=0/1` 도입 (기본값 0)
  2. 추천 엔진 호출 지점에서 flag=0이면 예외 대신 **시나리오 기반 더미 결과** 또는 “미지원” 응답 반환
  3. 로그에 flag 상태와 차단 여부를 남김 (민감정보 제외)
- **수용 기준(AC)**
  - flag=0일 때 추천 엔진 코드 경로가 실행되지 않는다(단위테스트 또는 로그로 검증)
  - API가 500이 아닌 200/4xx로 정상 응답한다(정의된 에러 코드/메시지)
- **산출물**
  - PR 1개, 변경 로그 포함

### A-2. 추천형 응답 필드/키워드 제거 (Backend Contract)
- **목적**: API 레벨에서 “추천처럼 보이는 데이터 구조” 제거
- **대상**
  - `backend/app/routes/portfolio.py` 응답 스키마
  - Pydantic 모델/DTO(있다면)
- **작업 내용**
  1. 응답 JSON에서 추천형 필드 제거 또는 대체
     - 예: `recommended_*`, `top_picks`, `reason`, “추천 예금” 관련 키 등
  2. 대체 필드는 시나리오/설명 기반으로 표준화
     - 예: `scenario_id`, `scenario_name`, `simulation_disclaimer`, `risk_summary`
  3. 문서/Swagger에도 동일 반영
- **수용 기준(AC)**
  - 응답에 “recommend/recommended/recommendation/추천” 문자열이 포함되지 않는다(스모크 테스트)
  - FE 빌드가 깨지지 않도록 변경사항을 명시(또는 A-3와 같은 PR에서 동시 반영)
- **비고**
  - FE를 함께 바꾸지 않으면 breaking change가 되므로, A-3와 동시 머지 전략 권장

### A-3. UI 카피 및 CTA에서 “추천” 제거 (Frontend)
- **목적**: 사용자 인지 수준에서 서비스 포지셔닝을 즉시 교정
- **대상 파일(검색 권장)**
  - `frontend/src/**/*` (버튼/메뉴/헤더/온보딩)
- **작업 내용**
  1. “추천받기/추천 포트폴리오/AI 추천” 문구를 전면 제거
  2. 대체 문구:
     - “시나리오 선택” / “모의실험 실행” / “결과 비교” / “리스크 특성 보기”
  3. 툴팁/설명문구에 “투자 권유 아님” 고지 유지 + “시뮬레이션 기반” 강조
- **수용 기준(AC)**
  - UI 주요 흐름에서 “추천” 문구가 0건(검색 결과)  
  - 주요 CTA가 “비교/시뮬레이션” 중심으로 변경

---

## Epic B. KPI 재정렬: 손실/회복 중심 전환

### B-1. 시뮬레이션 결과 응답 KPI 재정렬 (Backend)
- **목적**: Foresto 핵심 KPI(손실/회복)를 최상단으로 올리고 기대수익률 중심을 약화
- **대상**
  - 시뮬레이션 실행 라우터(예: `backend/app/routes/portfolio.py`의 simulate 계열)
  - `backend/app/routes/backtesting.py` (출력 구조 일부 공통화 가능)
- **작업 내용**
  1. 응답 구조를 다음 우선순위로 재정렬
     - `max_drawdown`, `max_recovery_days`, `worst_1m`, `worst_3m` (가능 시)
     - 그 다음 `cagr`, `volatility` 등
  2. “expected_return/예상 수익률”이 존재한다면:
     - 필드 삭제 또는 `historical_observation` 하위로 이동
     - 명칭도 “기대/예상” 금지 → “과거 관측치”로 제한
- **수용 기준(AC)**
  - API 응답의 top-level에 손실/회복 지표가 포함되고, 문서화되어 있다
  - 기대수익률 관련 키워드가 top-level에 존재하지 않는다

### B-2. 진단(설문) 결과의 `expected_annual_return` 제거/격하 (Backend)
- **목적**: “기대수익률” 오해 가능성 제거
- **대상 파일**
  - `backend/app/diagnosis.py`
- **작업 내용**
  1. `expected_annual_return` 필드 제거 또는 `reference_only` 하위로 이동
  2. 설문 결과는 “용어/UX 안내” 성격으로 리포맷
     - 예: `risk_profile_label`, `risk_profile_note`
- **수용 기준(AC)**
  - diagnosis 응답에서 `expected_*` 형태 필드가 제거되거나 비노출(기본) 상태
  - 관련 문구가 “보장/예상/기대”로 해석될 수 없도록 정리

### B-3. 결과 화면 UI를 손실/회복 중심으로 재배치 (Frontend)
- **목적**: 사용자 경험 자체를 Foresto 방향으로 정렬
- **작업 내용**
  1. 결과 요약 카드 상단: MDD, Recovery Days
  2. 차트/표에서 CAGR은 보조 지표로 하단 배치
  3. “해석 도움” 문구 추가(예: “낙폭이 크면 회복에 시간이 걸릴 수 있습니다”)
- **수용 기준(AC)**
  - 결과 첫 화면에서 손실/회복 지표가 가장 먼저 보인다
  - “수익률”은 보조로 노출된다

---

## Epic C. 시나리오 기반 흐름 도입 (MVP 스켈레톤)

### C-1. `GET /scenarios` 더미 API 제공 (Backend)
- **목적**: 추천 엔진을 대체할 최소한의 “관리형 시나리오” 엔드포인트 확보
- **작업 내용**
  1. `GET /scenarios` (리스트)
  2. `GET /scenarios/{id}` (상세)
  3. 초기에는 코드 상수 또는 JSON 파일로 3개 시나리오 제공
     - MIN_VOL(변동성 최소화), DEFENSIVE(방어), GROWTH(성장)
  4. 각 시나리오에 “설명문구(규제 안전)” 포함
- **수용 기준(AC)**
  - Swagger에서 2개 엔드포인트 확인 가능
  - FE가 시나리오 목록을 받아 렌더링 가능
- **비고**
  - DB 반영은 Phase 2(별도 Epic)로 미룸. 이번 티켓은 골격 확보가 목적.

### C-2. 시나리오 선택 → 시뮬레이션 실행 플로우 연결 (Frontend)
- **목적**: 제품의 주 흐름을 “설문→추천”에서 “시나리오→비교”로 전환
- **작업 내용**
  1. 첫 진입 화면에 시나리오 리스트 노출
  2. 시나리오 선택 후 기간 입력(시작/종료 또는 기간) + 손실한도 입력(최대 허용 손실 %)
  3. “모의실험 실행” 버튼으로 시뮬레이션 호출
- **수용 기준(AC)**
  - 설문을 하지 않아도 시나리오 기반 시뮬레이션까지 도달 가능
  - CTA/카피에 “추천” 없음

### C-3. 설문 기능은 “옵션 도구”로 격하 (Frontend + Backend 문구)
- **목적**: 설문이 핵심 판단 주체로 오인되지 않도록 위치 조정
- **작업 내용**
  1. 설문 진입을 “추가 입력(선택)” 또는 “용어 이해 돕기”로 변경
  2. 설문 결과는 시나리오 추천이 아니라 “읽기 가이드” 수준으로만 표시
- **수용 기준(AC)**
  - 설문 완료 여부와 무관하게 핵심 플로우(시나리오→시뮬레이션)가 동일하게 동작
  - 설문 결과가 시나리오 선택을 강제하지 않는다

---

## Epic D. 재현성 최소요건: request_hash 캐시

### D-1. 시뮬레이션 요청 해시 생성 및 결과 재사용 (Backend)
- **목적**: 동일 입력 → 동일 결과 재현 및 캐시 효율 확보
- **대상**
  - 시뮬레이션 실행 라우터
  - 저장 모델(기존 테이블 활용 가능)
- **작업 내용**
  1. 요청 바디를 canonicalize(키 정렬, 불필요 필드 제거) 후 SHA-256로 `request_hash` 생성
  2. 동일 해시가 기존에 있으면 결과 반환 (새 계산 스킵)
  3. 응답에 `request_hash` 포함(디버깅/추적용)
- **수용 기준(AC)**
  - 동일 요청 2회 호출 시 2번째는 캐시 hit(로그/메트릭)로 확인 가능
  - 결과 payload가 동일하다(핵심 지표 기준)

### D-2. 엔진/모델 버전 문자열을 응답 및 저장에 포함 (Backend)
- **목적**: 향후 모델 변경 시에도 결과 재현 가능하게 추적
- **작업 내용**
  1. 환경변수 `ENGINE_VERSION` 도입
  2. 시뮬레이션 결과 저장 레코드에 engine_version 저장(기존 테이블에 컬럼 추가 또는 JSON에 포함)
  3. 응답에도 `engine_version` 포함
- **수용 기준(AC)**
  - 모든 시뮬레이션 응답에 engine_version이 존재
  - 저장된 결과에서도 확인 가능

---

## Epic E. 품질/검증: 금지어 탐지 및 스모크 테스트

### E-1. 금지어(추천/보장 등) 스캔 스크립트 추가 (Repo)
- **목적**: PR 머지 전에 “추천성 표현”이 다시 유입되는 것을 방지
- **작업 내용**
  1. 간단한 grep 기반 스크립트 추가(예: `scripts/forbidden_terms_check.sh`)
  2. CI(있다면)에 연결 또는 개발자 로컬 pre-commit 가이드 제공
  3. 금지어 목록을 문서로 유지(`docs/forbidden_terms.md`)
- **수용 기준(AC)**
  - 스크립트 실행 시 금지어 존재하면 non-zero exit
  - 금지어 목록이 단일 소스로 관리됨

### E-2. 시나리오 API/시뮬레이션 API 스모크 테스트 추가 (Backend)
- **목적**: 계약 변경으로 FE가 깨지는 것을 조기 탐지
- **작업 내용**
  - pytest 또는 기존 테스트 프레임에 다음 추가:
    - `GET /scenarios` 200 + schema 검증
    - 시뮬레이션 실행 200 + top-level KPI 존재(MDD/Recovery)
- **수용 기준(AC)**
  - 로컬 테스트에서 통과
  - 최소 핵심 KPI가 누락되면 실패하도록 구성

---

## Merge 권장 순서(충돌 최소화)
1) A-1 (추천 엔진 차단)  
2) A-2 + A-3 (응답/카피 동시 변경)  
3) B-1 + B-2 + B-3 (손실/회복 중심 전환)  
4) C-1 + C-2 + C-3 (시나리오 플로우)  
5) D-1 + D-2 (request_hash/버전)  
6) E-1 + E-2 (품질 게이트)

---

## 부록: PR 템플릿(권장)
각 PR 본문에 아래를 포함한다.

- 변경 목적(Foresto 정합성 관점)
- 영향 범위(Backend/Frontend/DB)
- 금지어 스캔 결과(통과 여부)
- API 응답 샘플(변경 전/후, 필요한 경우)
- 롤백 방법(Feature Flag 포함)
