# Phase 9 E2E 테스트 케이스 상세 정의서

작성일: 2026-01-22

## 1. 개요

### 1.1 목적
Phase 9 릴리스 전 운영 시나리오 기반 E2E(End-to-End) 테스트를 통해 시스템 안정성을 검증한다.

### 1.2 테스트 범위
- Phase 7 포트폴리오 평가 핵심 플로우
- 포트폴리오 비교 기능
- 입력 오류/극단값 처리
- 레이트 리밋 및 대량 요청
- 결과 재현성 및 불변성

### 1.3 테스트 환경
- Backend: FastAPI + PostgreSQL
- 테스트 프레임워크: pytest
- 테스트 위치: `backend/tests/e2e/`

---

## 2. 시나리오 1: 신규 사용자 포트폴리오 평가 플로우

### TC-1.1: 신규 사용자 회원가입 → 포트폴리오 생성 → 평가 → 결과 확인

| 항목 | 내용 |
|------|------|
| **ID** | TC-1.1 |
| **우선순위** | P0 |
| **전제조건** | 테스트 DB에 시계열 데이터 적재 |
| **시나리오** | 신규 사용자가 회원가입 후 포트폴리오를 생성하고 과거 데이터 기반 평가를 실행하여 결과를 확인한다 |

**테스트 단계:**

| Step | Action | Expected Result |
|------|--------|-----------------|
| 1 | POST `/auth/signup` (신규 사용자) | 201 Created, JWT 토큰 반환 |
| 2 | POST `/api/v1/phase7/portfolios` (포트폴리오 생성) | 201 Created, portfolio_id 반환 |
| 3 | POST `/api/v1/phase7/evaluations` (평가 실행) | 201 Created, metrics 포함 |
| 4 | GET `/api/v1/phase7/evaluations` (이력 조회) | 200 OK, count >= 1 |
| 5 | GET `/api/v1/phase7/evaluations/{id}` (상세 조회) | 200 OK, result_hash 존재 |

**검증 포인트:**
- [ ] 응답에 `disclaimer_version: "v2"` 포함
- [ ] `metrics` 객체에 `cumulative_return`, `cagr`, `volatility`, `max_drawdown` 포함
- [ ] `extensions` 객체 존재 (Phase 8-A 확장 지표)
- [ ] `result_hash` 값 존재 (재현성 검증용)

---

### TC-1.2: 포트폴리오 종목 구성 (단일 종목)

| 항목 | 내용 |
|------|------|
| **ID** | TC-1.2 |
| **우선순위** | P0 |
| **전제조건** | 인증된 사용자, 종목 시계열 데이터 존재 |

**테스트 데이터:**
```json
{
  "portfolio_type": "SECURITY",
  "portfolio_name": "단일 종목 테스트",
  "items": [
    { "item_key": "005930", "item_name": "삼성전자", "weight": 1.0 }
  ]
}
```

**검증 포인트:**
- [ ] 비중 합계 = 1.0 (100%)
- [ ] 평가 실행 성공
- [ ] 단일 종목 기여도 = 100%

---

### TC-1.3: 포트폴리오 종목 구성 (복수 종목)

| 항목 | 내용 |
|------|------|
| **ID** | TC-1.3 |
| **우선순위** | P0 |
| **전제조건** | 인증된 사용자, 복수 종목 시계열 데이터 존재 |

**테스트 데이터:**
```json
{
  "portfolio_type": "SECURITY",
  "portfolio_name": "복수 종목 테스트",
  "items": [
    { "item_key": "005930", "item_name": "삼성전자", "weight": 0.4 },
    { "item_key": "000660", "item_name": "SK하이닉스", "weight": 0.3 },
    { "item_key": "035420", "item_name": "NAVER", "weight": 0.3 }
  ]
}
```

**검증 포인트:**
- [ ] 비중 합계 = 1.0
- [ ] 각 종목별 기여도 계산 확인
- [ ] 포트폴리오 전체 지표 계산 정상

---

### TC-1.4: 리밸런싱 옵션별 평가

| 항목 | 내용 |
|------|------|
| **ID** | TC-1.4 |
| **우선순위** | P1 |
| **전제조건** | 포트폴리오 생성 완료 |

**테스트 케이스:**
| Rebalance | Expected |
|-----------|----------|
| `NONE` | 리밸런싱 없이 평가 |
| `MONTHLY` | 월간 리밸런싱 가정 |
| `QUARTERLY` | 분기 리밸런싱 가정 |

**검증 포인트:**
- [ ] 각 옵션별 평가 성공
- [ ] 리밸런싱 옵션에 따른 결과 차이 존재 (동일 포트폴리오)

---

## 3. 시나리오 2: 본인 포트폴리오 간 비교

### TC-2.1: 두 포트폴리오 비교

| 항목 | 내용 |
|------|------|
| **ID** | TC-2.1 |
| **우선순위** | P0 |
| **전제조건** | 동일 사용자의 두 포트폴리오에 대해 각각 평가 완료 |

**테스트 단계:**

| Step | Action | Expected Result |
|------|--------|-----------------|
| 1 | 포트폴리오 A 생성 및 평가 | 201 Created |
| 2 | 포트폴리오 B 생성 및 평가 | 201 Created |
| 3 | POST `/api/v1/phase7/comparisons` | 200 OK |

**Request Body:**
```json
{
  "portfolio_ids": [1, 2]
}
```

**검증 포인트:**
- [ ] `count: 2` 반환
- [ ] 각 포트폴리오별 `metrics` 포함
- [ ] `disclaimer_version: "v2"` 포함
- [ ] **우열 판단 표현 없음** (규제 준수)

---

### TC-2.2: 평가 미실행 포트폴리오 비교 시도

| 항목 | 내용 |
|------|------|
| **ID** | TC-2.2 |
| **우선순위** | P0 |
| **전제조건** | 포트폴리오 생성만 완료, 평가 미실행 |

**Expected Result:**
- HTTP 400 Bad Request
- 에러 메시지: 평가 결과가 없음을 안내

---

### TC-2.3: 타 사용자 포트폴리오 비교 차단

| 항목 | 내용 |
|------|------|
| **ID** | TC-2.3 |
| **우선순위** | P0 |
| **전제조건** | User A의 포트폴리오, User B의 토큰 |

**Expected Result:**
- HTTP 404 Not Found (포트폴리오 조회 불가)
- 타 사용자 포트폴리오에 대한 접근 차단 확인

---

## 4. 시나리오 3: 입력 오류/누락/극단값 처리

### TC-3.1: 잘못된 평가 기간 (start >= end)

| 항목 | 내용 |
|------|------|
| **ID** | TC-3.1 |
| **우선순위** | P0 |

**Request Body:**
```json
{
  "portfolio_id": 1,
  "period": { "start": "2024-01-10", "end": "2024-01-05" },
  "rebalance": "NONE"
}
```

**Expected Result:**
- HTTP 400 Bad Request
- 에러 메시지: "분석 기간을 확인해 주세요."

---

### TC-3.2: 미래 날짜 지정

| 항목 | 내용 |
|------|------|
| **ID** | TC-3.2 |
| **우선순위** | P0 |

**Request Body:**
```json
{
  "portfolio_id": 1,
  "period": { "start": "2024-01-01", "end": "2030-12-31" },
  "rebalance": "NONE"
}
```

**Expected Result:**
- HTTP 400 Bad Request
- 에러 메시지: "분석 기간을 확인해 주세요."

---

### TC-3.3: 존재하지 않는 포트폴리오 ID

| 항목 | 내용 |
|------|------|
| **ID** | TC-3.3 |
| **우선순위** | P0 |

**Request Body:**
```json
{
  "portfolio_id": 99999,
  "period": { "start": "2024-01-01", "end": "2024-01-10" },
  "rebalance": "NONE"
}
```

**Expected Result:**
- HTTP 404 Not Found
- 에러 메시지: "포트폴리오를 찾을 수 없습니다."

---

### TC-3.4: 비중 합계 != 100%

| 항목 | 내용 |
|------|------|
| **ID** | TC-3.4 |
| **우선순위** | P1 |

**테스트 케이스:**
| Case | Weights | Expected |
|------|---------|----------|
| 합계 < 100% | [0.3, 0.3] | 400 Bad Request |
| 합계 > 100% | [0.6, 0.6] | 400 Bad Request |

---

### TC-3.5: 데이터 없는 종목

| 항목 | 내용 |
|------|------|
| **ID** | TC-3.5 |
| **우선순위** | P1 |

**전제조건:** 시계열 데이터가 없는 종목 코드 사용

**Expected Result:**
- HTTP 400 Bad Request
- 에러 메시지: 데이터 부족 안내 (중립적 표현)

---

### TC-3.6: 극단값 입력 (매우 긴 기간)

| 항목 | 내용 |
|------|------|
| **ID** | TC-3.6 |
| **우선순위** | P1 |

**Request Body:**
```json
{
  "portfolio_id": 1,
  "period": { "start": "2000-01-01", "end": "2024-12-31" },
  "rebalance": "NONE"
}
```

**Expected Result:**
- 데이터 존재 시: 200 OK (정상 처리)
- 데이터 부족 시: 400 Bad Request (중립 오류)

---

## 5. 시나리오 4: 대량 요청/반복 요청 (레이트 리밋)

### TC-4.1: 연속 평가 요청

| 항목 | 내용 |
|------|------|
| **ID** | TC-4.1 |
| **우선순위** | P1 |

**테스트 단계:**
1. 동일 사용자로 10회 연속 평가 요청
2. 모든 요청 성공 확인 (레이트 리밋 이내)

**검증 포인트:**
- [ ] 10회 요청 모두 201 Created
- [ ] 응답 시간 일정 범위 내

---

### TC-4.2: 레이트 리밋 초과

| 항목 | 내용 |
|------|------|
| **ID** | TC-4.2 |
| **우선순위** | P1 |

**전제조건:** 레이트 리밋 활성화 환경

**테스트 단계:**
1. 레이트 리밋 임계치 초과 요청
2. 429 Too Many Requests 확인

**Expected Result:**
- HTTP 429 Too Many Requests
- `X-RateLimit-*` 헤더 포함

---

### TC-4.3: 동시 요청 처리

| 항목 | 내용 |
|------|------|
| **ID** | TC-4.3 |
| **우선순위** | P1 |

**테스트 단계:**
1. 5개 요청 동시 전송 (asyncio/threading)
2. 모든 요청 정상 처리 확인

**검증 포인트:**
- [ ] 5개 요청 모두 성공
- [ ] 데이터 무결성 유지 (중복 저장 없음)

---

## 6. 시나리오 5: 결과 재현성 검증

### TC-5.1: 동일 입력 → 동일 결과

| 항목 | 내용 |
|------|------|
| **ID** | TC-5.1 |
| **우선순위** | P0 |

**테스트 단계:**
1. 동일 입력으로 평가 요청 #1
2. 동일 입력으로 평가 요청 #2
3. 두 결과의 `result_hash` 비교

**검증 포인트:**
- [ ] `result_hash` 일치
- [ ] `metrics` 모든 값 일치
- [ ] `extensions` 모든 값 일치

---

### TC-5.2: 저장된 결과 조회 시 불변성

| 항목 | 내용 |
|------|------|
| **ID** | TC-5.2 |
| **우선순위** | P0 |

**테스트 단계:**
1. 평가 실행 및 결과 저장
2. 1시간 후 (또는 재시작 후) 동일 evaluation_id로 조회
3. 결과 일치 확인

**검증 포인트:**
- [ ] `result_hash` 일치
- [ ] `result_json` 내용 일치

---

### TC-5.3: 재처리(Replay) 결과 불변성

| 항목 | 내용 |
|------|------|
| **ID** | TC-5.3 |
| **우선순위** | P0 |

**테스트 단계:**
1. 원본 평가 결과 저장
2. 동일 입력으로 재처리 실행
3. 원본과 재처리 결과 비교

**검증 포인트:**
- [ ] 데이터 변경 없는 경우: 결과 동일
- [ ] `result_hash` 일치

---

## 7. 시나리오 6: 로그·감사 이벤트 검증

### TC-6.1: 평가 실행 시 감사 로그 생성

| 항목 | 내용 |
|------|------|
| **ID** | TC-6.1 |
| **우선순위** | P1 |

**검증 포인트:**
- [ ] 평가 실행 시 `OpsAuditLog` 레코드 생성
- [ ] `input_hash` 기록
- [ ] `evaluation_version` 기록
- [ ] `user_id` 기록

---

### TC-6.2: 사용자 액션 이벤트 기록

| 항목 | 내용 |
|------|------|
| **ID** | TC-6.2 |
| **우선순위** | P1 |

**검증 포인트:**
- [ ] 포트폴리오 생성 이벤트
- [ ] 평가 실행 이벤트
- [ ] 결과 조회 이벤트

---

## 8. 시나리오 7: 타임아웃/재시도 정책

### TC-7.1: 장시간 평가 요청 타임아웃

| 항목 | 내용 |
|------|------|
| **ID** | TC-7.1 |
| **우선순위** | P1 |

**전제조건:** 의도적으로 느린 처리 시뮬레이션

**Expected Result:**
- 타임아웃 시 적절한 에러 응답
- 클라이언트에 재시도 안내

---

### TC-7.2: 일시적 오류 후 재시도

| 항목 | 내용 |
|------|------|
| **ID** | TC-7.2 |
| **우선순위** | P1 |

**전제조건:** DB 일시적 연결 오류 시뮬레이션

**검증 포인트:**
- [ ] 재시도 정책에 따른 복구
- [ ] 최종 성공 또는 명확한 실패 응답

---

## 9. 테스트 데이터 요구사항

### 9.1 시계열 데이터
```python
# 최소 테스트 데이터
tickers = ["005930", "000660", "035420"]
date_range = "2024-01-01" ~ "2024-12-31"
fields = ["open", "high", "low", "close", "volume"]
```

### 9.2 테스트 사용자
```python
test_users = [
    {"email": "e2e_user_a@test.com", "role": "user"},
    {"email": "e2e_user_b@test.com", "role": "user"},
]
```

---

## 10. 테스트 코드 위치

| 파일 | 시나리오 |
|------|----------|
| `backend/tests/e2e/test_phase9_evaluation_flow.py` | TC-1.x |
| `backend/tests/e2e/test_phase9_comparison.py` | TC-2.x |
| `backend/tests/e2e/test_phase9_error_handling.py` | TC-3.x |
| `backend/tests/e2e/test_phase9_rate_limit.py` | TC-4.x |
| `backend/tests/e2e/test_phase9_reproducibility.py` | TC-5.x |
| `backend/tests/e2e/test_phase9_audit_log.py` | TC-6.x |
| `backend/tests/e2e/test_phase9_timeout_retry.py` | TC-7.x |

---

## 11. 실행 명령

```bash
# 전체 E2E 테스트 실행
pytest backend/tests/e2e/ -v -m e2e

# 특정 시나리오 실행
pytest backend/tests/e2e/test_phase9_evaluation_flow.py -v

# 우선순위 P0만 실행
pytest backend/tests/e2e/ -v -m "e2e and p0"
```

---

## 12. 완료 기준

### 12.1 P0 필수 통과
- [ ] TC-1.1: 신규 사용자 평가 플로우
- [ ] TC-1.2, TC-1.3: 포트폴리오 구성
- [ ] TC-2.1: 포트폴리오 비교
- [ ] TC-2.2, TC-2.3: 비교 제한 검증
- [ ] TC-3.1, TC-3.2, TC-3.3: 입력 오류 처리
- [ ] TC-5.1, TC-5.2, TC-5.3: 결과 재현성

### 12.2 P1 권장 통과
- [ ] TC-1.4: 리밸런싱 옵션
- [ ] TC-3.4, TC-3.5, TC-3.6: 극단값 처리
- [ ] TC-4.x: 레이트 리밋
- [ ] TC-6.x: 감사 로그
- [ ] TC-7.x: 타임아웃/재시도

---

## 13. 산출물

| 산출물 | 설명 |
|--------|------|
| `phase9_e2e_test_cases.md` | 본 문서 |
| `phase9_e2e_test_report.md` | 테스트 실행 결과 보고서 (테스트 완료 후 작성) |
