# Phase 5 운영 Runbook v1

## 목적
외부 노출 단계에서 발생할 수 있는 장애/비정상 상황에 대한 대응 절차를 표준화한다.

## 서비스 구성도 요약
- Frontend: Vercel
- Backend: Render
- Database: 운영 DB (환경 변수로 주입)
- 외부 의존성: Alpha Vantage, Claude API

## 공통 대응 절차
1) 영향 범위 파악  
2) 원인 가설 수립  
3) 임시 조치  
4) 원인 확정/조치  
5) 복구 확인  
6) 사후 보고

## 시나리오

### 1. API 오류율 급증
- 증상: 5xx 오류율 상승
- 확인: 최근 배포/로그/대시보드
- 조치: 롤백 또는 트래픽 차단

### 2. 응답 지연
- 증상: p95/p99 급등
- 확인: DB/외부 의존성 상태
- 조치: 스케일 업, 캐시, 재시도 제한

### 3. 배치 지연/실패
- 증상: 배치 미완료, 스케줄 실패 알림
- 확인: 배치 로그/스케줄러 상태
- 조치: 재실행 또는 이전 결과 유지

### 4. 데이터 불일치
- 증상: 리포트/지표 불일치
- 확인: 데이터 소스/버전 스냅샷 비교
- 조치: 데이터 재집계, 변경 이력 확인

### 5. Guard 차단 실패
- 증상: 추천/선정 경로 호출 성공 로그
- 확인: 규칙/필터/라우팅
- 조치: 즉시 차단 및 배포 중단

## 릴리스 전략 (Canary/롤백)

### 제한 공개 기준
- 신규 트래픽 5% 이하로 시작
- 오류율/지연 기준 충족 시 25% → 50% → 100% 확대

### 롤백 트리거
- 5xx 오류율 > 1% (5분 지속)
- p99 > 2s (5분 지속)
- Guard 차단 실패 로그 발생

### 롤백 절차
1) 트래픽 즉시 감소  
2) 이전 안정 버전으로 롤백  
3) 스모크 테스트  
4) 장애 보고 및 재발 방지

## 롤백/복구 절차
1) 배포 중단  
2) 이전 안정 버전으로 롤백  
3) 핵심 플로우 스모크 테스트  
4) 장애 공지 및 사후 보고

## 담당자/연락 체계
- 온콜: ops@company.local
- 알림 채널: Slack #ops-alerts
- 에스컬레이션: tech-lead -> product-owner

## 사후 보고
- 타임라인
- 원인 분석
- 재발 방지
